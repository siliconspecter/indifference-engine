on:
  push:
    branches:
      - main

jobs:
  public-api-documentation:
    if: github.repository == 'siliconspecter/indifference-engine'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          path: main

      - run: sudo apt-get install doxygen

      - run: make api_documentation
        working-directory: main/deliverables/wasm_module

      - uses: actions/checkout@v3
        with:
          repository: siliconspecter/indifference-engine-api-documentation
          path: pages

      - run: find pages -mindepth 1 -maxdepth 1 -not -name ".git" -delete

      - run: cp -r main/deliverables/wasm_module/ephemeral/api_documentation/* pages

      - run: git config user.email siliconspecter@outlook.com
        working-directory: pages

      - run: git config user.name siliconspecter
        working-directory: pages

      - run: git add --all
        working-directory: pages

      - run: git remote set-url origin https://x-access-token:${INDIFFERENCE_ENGINE_API_DOCUMENTATION_TOKEN}@github.com/siliconspecter/indifference-engine-api-documentation.git
        working-directory: pages

      - run: git diff --staged --quiet --exit-code || (git commit --message "Update pushed automatically."; git push)
        working-directory: pages
